<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.73/dist/themes/light.css" rel="stylesheet"/>
  <title>Document</title>
  <style>
    .visible {
      visibility: visible;
      opacity: 1;
      transition: opacity .5s linear;
    }
    .hidden {
      visibility: hidden;
      opacity: 0;
      transition: visibility 0s .5s, opacity .5s linear;
    }
  </style>
</head>
  <div id="app" ref="app" v-html="html" class="hidden"></div>
<body>
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.73/dist/shoelace.js" type="module"></script>
  <script src="https://unpkg.com/visual-essays/dist/visual-essays/visual-essays.esm.js" type="module"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/http-vue-loader@1.4.2/src/httpVueLoader.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/yamljs/0.3.0/yaml.min.js" integrity="sha512-f/K0Q5lZ1SrdNdjc2BO2I5kTx8E5Uw1EU3PhSUB9fYPohap5rPWEmQRCjtpDxNmQB4/+MMI/Cf+nvh1VSiwrTA==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.2/umd/popper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tippy.js/6.3.7/tippy.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/ScrollMagic/2.0.7/ScrollMagic.min.js" type="text/javascript"></script>
  <!-- This is used for deep linking of Single Page Apps when hosted with GitHub Pages -->
  <script type="text/javascript">
    (function(l) {
      if (l.search[1] === '/' ) {
        let decoded = l.search.slice(1).split('&').map(s => s.replace(/~and~/g, '&')).join('?')
        window.history.replaceState(null, null, l.pathname.slice(0, -1) + decoded + l.hash)
      }
    }(window.location))
  </script>
  <script type="module">
    new Vue({
      el: '#app',
      data: () => ({
        acct: '',
        repo: '',
        ref: null,
        html: null
      }),
      mounted() {
        let isGhp = location.host.indexOf('github.io') > 0
        let pathElems = location.pathname.split('/').filter(elem => elem)
        this.acct = isGhp
          ? location.host.split('.')[0]
          : pathElems.length > 0 ? pathElems[0] : ''
        this.repo = isGhp
          ? pathElems.length > 0 ? pathElems[0] : ''
          : pathElems.length > 1 ? pathElems[1] : ''
        this.ref = (new URL(location.href).searchParams.get('ref'))
        this.path = pathElems.slice(isGhp ? 1 : 2).join('/')
        console.log(`acct=${this.acct} repo=${this.repo} path=${this.path} ref=${this.ref}`)
        this.loadPage()
      },
      methods: {
        loadPage() {
          let path = this.path.split('/').filter(elem => elem).join('/')
          let prefix = [this.acct, this.repo].filter(elem => elem).join('/')
          let url = `https://api.juncture-digital.org/html/${path}${path === '' ? '' : '/'}`
          if (prefix) url += `?prefix=${prefix}`
          if (this.ref) url += `${prefix ? '&' : '?'}ref=${this.ref}`
          console.log('loadPage', url)
          fetch(url).then(resp => resp.text())
          .then(html => {
            let [head, body] = new DOMParser().parseFromString(html, 'text/html').children[0].children
            
            Array.from(head.querySelectorAll('style')).forEach(el => {
              const style = document.createElement('style')
              style.textContent = el.textContent
              document.querySelector('head').appendChild(style)
            })

            this.html = body.children[0].innerHTML
            
            Array.from(body.querySelectorAll('script')).forEach(el => {
              const script = document.createElement('script')
              if (el.type) script.type = el.type
              if (el.src) script.src = el.src
              else script.text = el.text
              document.querySelector('body').appendChild(script)
            })
            document.getElementById('app').className = 'visible'
          })
        }
      }
    })
    Vue.config.productionTip = false
    Vue.config.devtools = true
  </script>
</body>
</html>
